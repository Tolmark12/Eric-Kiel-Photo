<% object, object_class = pile.get_object, pile.get_object_class_str %>
<% object_str_underscore = p.get_object_str_underscore %>
<% column_count, row_count = pile.get_column_count, pile.get_row_count %>
<% element_class, element_count, elements = pile.get_attribute_class, pile.get_attribute_count, pile.get_attribute_relation.to_a %>
<% element_str_underscore = p.get_attribute_str_underscore %>
<% associated_elements = object.send("#{element_str_underscore}_ids".to_sym) %>
<div class="updatable">
<div class="link-bar">
	<%= link_to "#", :onclick=> "$('.chart-area li a:not(.active)').click(); return false;" do %>Select All<% end %>|
	<%= link_to "#", :onclick=> "$('.chart-area li a.active').click(); return false;" do %>De-Select All<% end %>|
	<%= link_to "#", :onclick=> "$('.chart-area li a').click(); return false;" do %>Toggle All<% end %>
	<div class="right-side">
		<% if p.paginatable? %>
		<p>Page</p>
		<%= p.prev_paginatable :title => '', :class => 'left-arrow' %>
		<input type="text" name="page" class="paginatable" value="<%= p.get_page_number %>" />
		<%= p.next_paginatable :title => '', :class => 'right-arrow' %>
		<p>of</p>
		<p><%= p.get_page_count %></p>
		<% end %>
	</div>
</div>
<div class="chart-area">
	<div class="titles">
		<ul>
			<% (0..column_count-1).each do |column_number| %>
				<li class="<%= "last" if column_number == column_count-1 %>">
					<%= (column_number * row_count) + 1 %> - <%= (column_number + 1) * row_count %>
			    </li>
			<% end %>				
		</ul>
	</div>
		<div class="background-grey">
			<% (0..column_count-1).each do |column_number| %>
				<ul class="<%= "last" if column_number == column_count-1 %>">
					<% (0..row_count-1).each do |row_number| %>
					    <% element_index = (column_number)*row_count+row_number %>
					    <% if element_index < element_count && !elements[element_index].nil?
						   element = elements[element_index]%>
					    <% css_classes = [("active" if associated_elements.include?(element.id)) ]%>
						<li id="<%= "li_#{element_str_underscore}_#{element.id}" %>" href="#" title="<%= element.send(pile.get_attribute_label) %>"><a id="<%= "#{element_str_underscore}_#{element.id}" %>" href="#" title="<%= element.send(pile.get_attribute_label) %>" class="<%= css_classes.join(' ') %>">
							 <% if p.is_label_image? then %>
							 <%= image_tag(element.send(pile.get_attribute_label), {:size => "50x50"})%>
							 <% else %>
						     <%= element.send(pile.get_attribute_label)[0,9] %>...
							 <% end %></a>
							<% if p.get_tooltip then %>
								<% tooltip = p.get_tooltip
								   last_item =  tooltip[-1]%>
								<div class="info-wrapper"  style="display:none;">
									<div class="background">
										<div class="tab"></div>
										<table class="info-box">
											<% tooltip.each { |t|%>
												<tr class="<%= "#{"first" if t == tooltip[0]} #{"last" if t == tooltip[-1]}"%>">
													<td class="left"><%=t.titleize%><span>:</span></td> 
													<td class="right"><%=element.send(t)%></td>
												</tr>
											<% } %>
										</table>
									</div>
								 </div>
							<% end %>
						</li>
						<% end %>
					<% end %>
			    </ul>
			<% end %>
		</div>
	</div>
	<%= pile.paginatable_ajax if pile.paginatable? && p.get_options[:ajax] %>
	<script type="text/javascript">
	<% if p.get_tooltip then %>
	var showTooltipTimeouts = new Array();
	var isHovering = new Array();
	var blockOthers = false;
	function hideTooltip(liId) {
		if (liId) {
			var infoBox = $('#'+liId).children('.info-wrapper');
			infoBox.fadeOut('fast',function() {
								var infoBox = $(this);
								infoBox.attr('id','');
								infoBox.fadeOut();
								infoBox.css('top','').css('bottom','').css('left','').css('right','');
							});
			blockOthers = false;
		}
	}
	function showTooltip(liId) {
		if (liId && isHovering[liId] && !blockOthers) {
			blockOthers = true;
			var li = $('#'+liId);
			var infoBox = li.children('.info-wrapper');
			var windowPane = li.parents('div:first');
			var topOfWindow = windowPane.offset().top;
			var leftOfWindow = windowPane.offset().left;
			var topDistance = li.offset().top - topOfWindow;
			var bottomDistance = (topOfWindow + windowPane.height()) - li.offset().top;
			var leftDistance = li.offset().left - leftOfWindow;
			var rightDistance = (leftOfWindow + windowPane.width()) - li.offset().left;
			var max = Math.max(topDistance,bottomDistance,leftDistance,rightDistance);
						
			if (max == topDistance) {
				infoBox.addClass('bottom');
				infoBox.css('top', '-' + (infoBox.height()+20)+'px');
			} else if (max == bottomDistance) {
				infoBox.addClass('top');
				infoBox.css('top', (infoBox.height()-20)+'px');
			} else 	if (max == rightDistance) {
				infoBox.addClass('left');
				infoBox.css('top', '-'+(infoBox.height()/2)+'px');
				infoBox.css('left', (infoBox.width()-20)+'px');
			} else {
				infoBox.addClass('right');
				infoBox.css('top', '-'+(infoBox.height()/2)+'px');
				infoBox.css('left', '-'+(li.width()+infoBox.width()-20)+'px');
			}
			infoBox.show();
			infoBox.attr('id', 'dhtmltooltip');
			infoBox.fadeIn();
		}
	}
	<% end %>
//<![CDATA[
$(document).ready(function() {
    $('#<%= pile.get_id %> .updatable').delegate('li a','click',function() {
        if ($(this).hasClass('active')) {
            $("#<%= pile.get_destination %> input[value='" + this.id.replace("<%=element_str_underscore %>_", "") + "']").remove();
            <%=raw %|
                $('#sort_' + this.id).remove();
                $("ul.sortable > li.ui-state-default > span").each(function(index, value) {
                    $(value).html(index + 1);
                });
            | if p.is_orderable? %>
        } else {
            $('#<%= pile.get_destination %>').append("<input name='<%=object_str_underscore %>[<%=element_str_underscore %>_ids][]' type='hidden' value='" + this.id.replace("<%=element_str_underscore %>_", "") + "' />");
            <%=raw %|
                var lastInOrder = $('ul.sortable > li:last');
                if (lastInOrder.length > 0) {
                	var curNumber = parseInt(lastInOrder.children('span').text()) + 1;
                	var sortableItem = $('<li id="sort_' + this.id + '" class="ui-state-default"><span>' + curNumber + '</span><a>' + $(this).html() + '</a></li>');
                    lastInOrder.after(sortableItem);
                 } else {
	                var curNumber = 1;
                	var sortableItem = $('<li id="sort_' + this.id + '" class="ui-state-default"><span>' + curNumber + '</span><a>' + $(this).html() + '</a></li>');
                    $('ul.sortable:first').append(sortableItem);
				}
				| if p.is_orderable? %>
            }
            $(this).toggleClass('active');
            return false;
        });
		<% if p.get_tooltip then %>
		$('#<%= pile.get_id %> .updatable').delegate('li','mouseenter',function () {
			var id = $(this).attr('id');
			isHovering[id] = true;	
			showTooltipTimeouts[id] = setTimeout("showTooltip('"+id+"')",200);
		});
		$('#<%= pile.get_id %> .updatable').delegate('li', 'mouseleave',function () {
			var id = $(this).attr('id');
			delete isHovering[id];	
			clearTimeout(showTooltipTimeouts[id]);
			delete showTooltipTimeouts[id];
			hideTooltip(id);
		});
		<% end %>
    });		
	   //]]>
	</script>
</div>